<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Follow Mini App</title>

    <!-- ğŸŸ£ Farcaster Frame Metadata -->
    <meta name="fc:frame" content="vNext" />
    <meta name="fc:frame:post_url" content="https://follow-farcasterr.vercel.app/" />
    <meta name="fc:frame:image" content="https://upload.wikimedia.org/wikipedia/commons/9/9a/Farcaster_logo.png" />
    <meta name="fc:frame:button:1" content="Open App" />

    <!-- ğŸ–¼ï¸ OG Metadata -->
    <meta property="og:title" content="Follow Farcaster Mini App" />
    <meta property="og:description" content="Login dan follow user Farcaster dengan mudah" />
    <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/9/9a/Farcaster_logo.png" />
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/9/9a/Farcaster_logo.png" />
  </head>

  <body style="font-family:sans-serif;text-align:center;margin-top:80px;">
    <h2>Login ke Farcaster</h2>
    <button id="loginBtn">Sign in with Farcaster</button>
    <div id="userInfo"></div>
    <br />
    <input id="username" placeholder="Masukkan username untuk di-follow" />
    <button id="followBtn" style="display:none;">Follow</button>
    <p id="status"></p>

    <script>
      const CLIENT_ID = "468536e4-a0e8-4673-969d-cfe28cebb84b"; // Ganti dengan Client ID kamu
      const API_KEY = "C84CFA1C-7A3D-4ACC-8438-E78846E02DD2"; // Ganti dengan API Key kamu
      const REDIRECT_URI = window.location.origin + "/";

      // ===== LOGIN BUTTON =====
      document.getElementById("loginBtn").onclick = () => {
        const url = `https://app.neynar.com/login?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(
          REDIRECT_URI
        )}&scope=openid%20farcaster%20user`;
        window.location.href = url;
      };

      // ===== SETELAH LOGIN =====
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      if (code) {
        localStorage.setItem("neynar_code", code);
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("followBtn").style.display = "inline";
        document.getElementById("userInfo").innerText = "âœ… Sudah login dengan Farcaster!";
      }

      // ===== FUNGSI FOLLOW =====
      document.getElementById("followBtn").onclick = async () => {
        const token = localStorage.getItem("neynar_code");
        const username = document.getElementById("username").value.trim();
        const status = document.getElementById("status");
        if (!username) return (status.innerText = "âš ï¸ Isi username dulu!");

        try {
          status.innerText = "ğŸ” Mencari user...";
          const userRes = await fetch(
            `https://api.neynar.com/v2/farcaster/user-by-username?username=${username}`,
            { headers: { api_key: API_KEY } }
          );
          const userData = await userRes.json();
          if (!userData.user) return (status.innerText = "âŒ User tidak ditemukan!");

          const targetFid = userData.user.fid;

          status.innerText = `ğŸ“¡ Mengirim permintaan follow ke ${username}...`;

          const res = await fetch("https://api.neynar.com/v2/farcaster/user/follow", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              api_key: API_KEY,
            },
            body: JSON.stringify({
              target_fid: targetFid,
              signer_authorization_code: token,
            }),
          });

          const result = await res.json();

          if (result.success) {
            status.innerText = `âœ… Berhasil follow @${username}`;
          } else {
            status.innerText = `ğŸš« Gagal follow: ${result.message || "Unknown error"}`;
          }
        } catch (err) {
          console.error(err);
          status.innerText = "âŒ Terjadi kesalahan jaringan.";
        }
      };
    </script>
  </body>
</html>
