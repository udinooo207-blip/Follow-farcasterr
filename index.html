<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Follow Mini App</title>
  </head>
  <body style="font-family:sans-serif;text-align:center;margin-top:80px;">
    <h2>Login ke Farcaster</h2>
    <button id="loginBtn">Sign in with Farcaster</button>
    <div id="userInfo"></div>
    <br/>
    <input id="username" placeholder="Masukkan username untuk di-follow"/>
    <button id="followBtn" style="display:none;">Follow</button>
    <p id="status"></p>

    <script>
      const CLIENT_ID = "468536e4-a0e8-4673-969d-cfe28cebb84b"; // Ganti ini
      const REDIRECT_URI = window.location.origin + "/";

      document.getElementById("loginBtn").onclick = () => {
        const url = `https://app.neynar.com/login?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(
          REDIRECT_URI
        )}&scope=openid%20farcaster%20user`;
        window.location.href = url;
      };

      // Setelah login
      const params = new URLSearchParams(window.location.search);
      const token = params.get("code");
      if (token) {
        localStorage.setItem("farcaster_code", token);
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("followBtn").style.display = "inline";
        document.getElementById("userInfo").innerText = "✅ Sudah login dengan Farcaster!";
      }

      document.getElementById("followBtn").onclick = async () => {
        const code = localStorage.getItem("farcaster_code");
        const username = document.getElementById("username").value.trim();
        const status = document.getElementById("status");
        if (!username) return (status.innerText = "Isi username dulu");

        try {
          status.innerText = "🔍 Mencari user...";
          const userRes = await fetch(
            `https://api.neynar.com/v2/farcaster/user-by-username?username=${username}`,
            { headers: { api_key: "C84CFA1C-7A3D-4ACC-8438-E78846E02DD2" } }
          );
          const userData = await userRes.json();
          if (!userData.user) return (status.innerText = "❌ User tidak ditemukan!");

          const fid = userData.user.fid;
          status.innerText = `➡️ Siap follow ${username} (fid: ${fid})`;

          // Catatan: Untuk follow sungguhan, nanti harus kirim request pakai signer user (farcaster actions)
          status.innerText += "\n🧠 Step berikutnya: integrasi dengan Neynar Action API untuk follow otomatis.";
        } catch (err) {
          console.error(err);
          status.innerText = "🚫 Terjadi error koneksi.";
        }
      };
    </script>
  </body>
</html>
